# CSRF 対策を実装する

## 背景

- 現在の API の実装は CSRF 脆弱性を考慮していない

## 対応内容

1. (backend) GET リクエストに対して CSRF トークンを生成し、set-Cookie (~~httpOnly, secure,~~ sameSite=Lax) で送信する
   - CSRF トークン生成と set-Cookie する処理はミドルウェアとして実装する
   - GET リクエストに対してのみ適用する
2. (backend) CSRF トークン生成のミドルウェアのテストを実装する
   - テストは `backend/tests/middleware/csrf-token.test.ts` に実装する
   - `supertest` を使ったテストを行う
3. (frontend) POST リクエストの際に、CSRF トークンをヘッダー (X-CSRF-Token) に含めて送信する
4. (backend) `X-CSRF-Token` ヘッダーを許容する
5. (backend) GET 以外のリクエストに対して CSRF トークンの検証を行う
   - `X-CSRF-Token` ヘッダーと Cookie から送信された CSRF トークンを検証するミドルウェアを実装する
   - 検証した結果、一致しない場合は 403 Forbidden を返す
     - ミドルウェアは `throw new CSRFError` して、エラーハンドリング用のミドルウェアが 403 Forbidden を返すようにする
   - 検証した結果、一致する場合は、次のミドルウェアに処理を委譲する
6. (backend) CSRF トークン検証のミドルウェアのテストを実装する
   - テストは `backend/tests/middleware/csrf-token.test.ts` に実装する
   - `supertest` を使ったテストを行う
7. (frontend) 403 Forbidden が返ってきた場合は、ToDo 一覧ページにリダイレクトする
   - ToDo 一覧ページにリダイレクトさせることで `GET /todo` に対するリクエスト送信が行われ、CSRF トークンが再生成される
   - リダイレクト後に「操作に失敗しました。再度試してください」というエラーを snackbar で表示する

## 作業における注意点

- Implementation Plan, Task, Walkthrough は日本語で出力してください
- 対応内容の番号を振った段落ごとにコミットを作成すること
- 明記されていないエッジケースがある場合、事前に確認を取ってください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
- 独自に実装するよりも近しい機能を持つ実装がインストール済みのライブラリに存在する場合は、事前に提案してください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
  - 例: ページネーションを実装してほしいと依頼されていますが MUI の Pagination コンポーネントを使うのはどうでしょうか？
- テーブルに対する変更はマイグレーションファイルを作成して行うこと
  - マイグレーションは `backend/` にある `prisma` を使うこと
  - ホスト側から実行する場合は `127.0.0.1` を指定し、Shadow DB 作成のため `root` ユーザーを使用すること
  - データ損失を伴う変更がある場合は `--create-only` でファイル作成後に `deploy` する手順推奨
    - 作成: `DATABASE_URL="mysql://root:root_password@127.0.0.1:3306/todo_db" pnpm exec prisma migrate dev --name <migration_name> --create-only`
    - 適用: `DATABASE_URL="mysql://root:root_password@127.0.0.1:3306/todo_db" pnpm exec prisma migrate deploy`
    - 生成: `pnpm exec prisma generate`
  - テスト実行前にはテスト用 DB にもマイグレーションを適用（リセット）すること
    - `DATABASE_URL="mysql://root:root_password@127.0.0.1:3306/test_todo_db" pnpm exec prisma migrate reset --force`

## 許可済みコマンド

以下のコマンドは毎回確認を求めずに実行してよい (SafeToAutoRun: true)

- `git status`
- `git add .`
- `git commit -m "..."`
- `git log`
- `ls -R`
- `cat ...`
- `grep ...`
- `pnpm test:local`
- `pnpm build`
- `pnpm exec prisma generate`
